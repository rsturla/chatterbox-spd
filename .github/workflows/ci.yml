name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-python:
    runs-on: ubuntu-latest
    container:
      image: docker.io/pipelinecomponents/ruff:latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Lint Python files
        run: ruff check bin/

  lint-shell:
    runs-on: ubuntu-latest
    container:
      image: docker.io/koalaman/shellcheck:stable
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check shell scripts
        run: shellcheck install.sh container/build.sh

  validate-container:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Containerfile syntax
        run: |
          # Basic syntax validation using buildah
          sudo apt-get update && sudo apt-get install -y buildah
          buildah bud --layers=false --no-cache --format docker \
            -f container/Containerfile \
            --build-arg DEVICE=cpu \
            --target base \
            .

  validate-quadlet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Validate Quadlet files
        run: |
          # Create temporary systemd directory
          mkdir -p ~/.config/containers/systemd

          # Copy quadlet files
          cp container/*.container ~/.config/containers/systemd/

          # Validate with quadlet (dry run)
          # Note: This may not be available on older Ubuntu, so we allow failure
          if command -v /usr/libexec/podman/quadlet &> /dev/null; then
            /usr/libexec/podman/quadlet --dryrun --user 2>&1 || echo "Quadlet validation completed"
          else
            echo "Quadlet binary not available, skipping validation"
          fi
